---
title: 浏览器事件循环
---

# 浏览器事件循环

为了协调事件、用户交互、脚本、UI 渲染、网络请求，用户代理必须使用事件循环机制（Event Loop）。

这种事件循环机制是由 JavaScript 的宿主环境来实现的，在浏览器运行环境中由浏览器内核引擎实现，而在 NodeJS 中则由 libuv 引擎实现。

主线程运行时候，产生堆（Heap）和栈（Stack），栈中的代码调用各种外部
API，它们在任务队列中加入各种事件。只要栈中的代码执行完毕，主线程就会通过事件循环机制读取任务队列，依次执行那些事件所对应的回调函数。

## 事件循环的执行过程

1. 首先执行同步任务。即从宏任务队列中取出一个任务执行，如果任务中又包含了新的宏任务，将其添加到宏任务队列中，如果任务中又包含了新的微任务，将其添加到微任务队列中。
2. 当同步任务执行完毕后，执行微任务队列中的所有任务。微任务队列中的所有任务都会在当前宏任务执行完毕之前执行完毕。
3. 微任务队列中的所有任务执行完毕后，执行宏任务队列中的下一个任务，重复执行步骤 1 和步骤 2，直到宏任务队列为空。
4. 当所有宏任务和微任务都执行完毕后，浏览器开始等待新的任务的到来，重复执行上述步骤。

## 宏任务

- script（整体代码）
- setTimeout
- setInterval
- I/O 操作
- UI 交互事件
- MessageChannel

## 微任务

- Promise
- MutationObserver
